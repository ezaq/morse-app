<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·é€å—ä¿¡ã‚¢ãƒ—ãƒª</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    video {
      width: 100%;
      height: auto;
      background: black;
    }
    .controls {
      display: flex;
      width: 100%;
      padding: 1em;
      background: #111;
    }
    input[type="text"] {
      flex: 1;
      font-size: 1.2em;
      padding: 0.5em;
      border: none;
      border-radius: 8px;
      margin-right: 1em;
    }
    button {
      font-size: 1.2em;
      padding: 0.5em 1em;
      border: none;
      border-radius: 8px;
      background: #0af;
      color: white;
    }
    .output-box {
      padding: 1em;
      width: 100%;
      background: #111;
      text-align: center;
      font-size: 1.2em;
    }
    .debug-box {
      padding: 1em;
      width: 100%;
      background: #222;
      text-align: center;
      font-size: 1.5em;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>
  <div class="controls">
    <input type="text" id="input" placeholder="è‹±æ•°å­—ã®ã¿å…¥åŠ›" pattern="[A-Za-z0-9]+">
    <button id="sendBtn">é€ä¿¡</button>
  </div>
  <div class="output-box" id="output">å—ä¿¡çµæœ: </div>
  <div class="debug-box" id="debug"></div>
  <div>ğŸŒï½–1.0.0ğŸŒš</div>

  <script>
    const MORSE_CODE = {
      A: '.-',     B: '-...',   C: '-.-.',  D: '-..',   E: '.',
      F: '..-.',  G: '--.',    H: '....',  I: '..',    J: '.---',
      K: '-.-',   L: '.-..',   M: '--',    N: '-.',    O: '---',
      P: '.--.',  Q: '--.-',   R: '.-.',   S: '...',   T: '-',
      U: '..-',   V: '...-',   W: '.--',   X: '-..-',  Y: '-.--',
      Z: '--..',
      0: '-----', 1: '.----', 2: '..---', 3: '...--', 4: '....-',
      5: '.....', 6: '-....', 7: '--...', 8: '---..', 9: '----.'
    };

    const REVERSE_MORSE = Object.fromEntries(Object.entries(MORSE_CODE).map(([k, v]) => [v, k]));

    const UNIT = 60000 / 10 / 50; // 10cpm
    const DOT = UNIT;
    const DASH = UNIT * 3;
    const SPACE = UNIT;
    const LETTER_SPACE = UNIT * 3;
    const WORD_SPACE = UNIT * 7;

    let track;
    let detecting = false;

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.getElementById('video');
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];
      startLightDetection(video);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function blinkMorse(text) {
      text = text.toUpperCase();
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === ' ') {
          await sleep(WORD_SPACE);
          continue;
        }
        const code = MORSE_CODE[char];
        if (!code) continue;

        for (let j = 0; j < code.length; j++) {
          const signal = code[j];
          await track.applyConstraints({ advanced: [{ torch: true }] });
          await sleep(signal === '.' ? DOT : DASH);
          await track.applyConstraints({ advanced: [{ torch: false }] });
          if (j < code.length - 1) await sleep(SPACE);
        }
        await sleep(LETTER_SPACE);
      }
    }

    document.getElementById('sendBtn').addEventListener('click', async () => {
      const input = document.getElementById('input').value;
      if (!/^[a-zA-Z0-9 ]+$/.test(input)) {
        alert('è‹±æ•°å­—ã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      await blinkMorse(input);
    });

    function startLightDetection(video) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      let signalHistory = [];
      let decodedText = '';
      let debugStr = '';

      function detectLoop() {
        if (!detecting) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

        let brightness = 0;
        for (let i = 0; i < frame.data.length; i += 4) {
          brightness += frame.data[i] + frame.data[i + 1] + frame.data[i + 2];
        }
        const avgBrightness = brightness / (frame.data.length / 4);

        const now = Date.now();
        const isLight = avgBrightness > 200;
        signalHistory.push({ t: now, v: isLight });

        // ğŸŒğŸŒš è¡¨ç¤º
        debugStr += isLight ? 'O' : 'X';
        if (debugStr.length > 100) debugStr = debugStr.slice(-100);
        document.getElementById('debug').textContent = debugStr;

        if (signalHistory.length > 10) {
          let result = decodeMorse(signalHistory);
          if (result) {
            decodedText += result;
            document.getElementById('output').textContent = 'å—ä¿¡çµæœx: ' + decodedText;
            signalHistory = [];
          }
        }

        requestAnimationFrame(detectLoop);
      }

      detecting = true;
      detectLoop();
    }

    function decodeMorse(history) {
      const pattern = history.map(p => p.v ? '1' : '0').join('');
      const count = pattern.match(/1+|0+/g)?.map(s => s.length) || [];
      if (count.length < 2) return '';
      const morse = count.map((len, i) => {
        if (i % 2 === 0) return len < 3 ? '.' : '-';
        return '';
      }).join('');
      return REVERSE_MORSE[morse] || '';
    }

    initCamera();
  </script>
</body>
</html>
